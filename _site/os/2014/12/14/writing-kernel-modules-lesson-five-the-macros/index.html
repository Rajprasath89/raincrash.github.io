<html>
  <head>
    <meta content='Writing Kernel Modules::The Macros - Bits, Pixels and Atoms' property='og:title' />
    <title>Writing Kernel Modules::The Macros - Bits, Pixels and Atoms</title>
    <link href='/images/fav.png' rel='shortcut icon'>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css' />
<link href='/stylesheets/style.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/syntax.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/responsive.css' rel='stylesheet' type='text/css' />
<!-- - -->
<script src='/javascripts/jquery.js' type='text/javascript'></script>
<script src='/javascripts/pd.js' type='text/javascript'></script>
<script src='/javascripts/basics.js' type='text/javascript'></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<!-- - -->
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <meta content='/os/2014/12/14/writing-kernel-modules-lesson-five-the-macros/' property='og:url' />
  <meta content="After writing our first [program](http://sricharanized.wordpress.com/2014/12/14/writing-kernel-modules-lesson-five-ou..." property='og:description' />
  <meta content="article" property="og:type" />

<!-- - -->
<script type='text/javascript'>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-61456015-1']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>
  </head>
  <body>
    <header>
<a id="go-back-home" href="/">
<h1>Sricharan Chiruvolu</h1>
<img src="/images/avatar.png" alt="Sricharan Chiruvolu" width="70" height="70"></a>
<p>Bits, Pixels and Atoms</p>
</header>
    <div id='container'>
      <div class="block">
  
    <a target="_top" class="main" href="/about">About</a>
  
    <a target="_blank" class="main" href="http://github.com/sricharanized/">GitHub</a>
  
    <a target="_blank" class="main" href="http://twitter.com/TheRaincrash/">Twitter</a>
  
    <a target="_blank" class="main" href="http://linkedin.com/in/sricharanchiruvolu">LinkedIn</a>
  
    <a target="_blank" class="main" href="http://quora.com/Sricharan-Chiruvolu">Quora</a>
  
    <a target="_blank" class="main" href="mailto:sricharanized@gmail.com">E-Mail</a>
  
</div>
      <section class="paging">
  
    <div class="left">
      <a href="/os/2014/12/14/writing-kernel-modules-lesson-five-our-first-kernel-module/">
        ‹
      </a>
    </div>
  
  
    <div class="right">
      <a href="/os/2014/12/15/writing-kernel-modules-lesson-five-multiple-file-modules-argument-passing/">
        ›
      </a>
    </div>
  
</section>
      <div class="content">
        <section class='post'>
          <h1 class="upcase">
            <div class='date'>14 Dec 2014</div>
            Writing Kernel Modules::The Macros
          </h1>
          <p>After writing our first <a href="http://sricharanized.wordpress.com/2014/12/14/writing-kernel-modules-lesson-five-our-first-kernel-module/">program</a>, we are now ready to modify it a litte. We will be using <code>module_init</code> and <code>module_exit</code> macros to rename our default <code>init_module()</code> and <code>cleanup_module()</code> respectively. Remember that you need to call these functions before calling the macros.</p>

<p>Also, We will be adding <code>__int</code> and <code>__exit</code> macros. These are macros to locate some parts of the linux code into special areas in the final executing binary. __init, for example instructs the compiler to mark this function in a special way. At the end the linker collects all functions with this mark at the end (or begin) of the binary file. If you what to know more you can read the <a href="http://lxr.free-electrons.com/source/include/linux/init.h">init.h</a> file along with the comments. This is the advantage of working with an open source operating system!</p>

<p>When the LKM starts, this code runs only once (initialization). After it runs, the kernel can free this memory to reuse it.</p>

<p>This is how our code was before we implimented it using modules.</p>

<pre><code>/* 
    Our first kernel module - first.c 
    Author: Sricharan Chiruvolu
    Date: 14 Dec 2014
*/
#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;

int init_module(void){

    printk(KERN_INFO "This is our first program.");

    return 0;
}

void cleanup_module(void){

    printk(KERN_INFO "End of our first program.");
}
</code></pre>

<p>We will now modify it as follows.</p>

<pre><code>/* 
    Edited first.c; Added macros module_init and module_exit
    Author: Sricharan Chiruvolu
    Date: 14 Dec 2014
*/
#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/init.h&gt;

static int __init firstInit(void)
{

    printk(KERN_ALERT "This is our first program.");
    return 0;
}

static void __exit firstExit(void)
{
    printk(KERN_ALERT "End of our first program.");
}

module_init(firstInit);
module_exit(firstExit);
</code></pre>

<p>Now you can <code>make</code> it. You will see that it behaves in the similar way as before. The difference? The attribute <strong>init, , will cause the initialization function to be discarded, and its memory reclaimed, after initialization is complete. It only works, however, for built-in drivers; it has no effect on modules. </strong>exit, instead, causes the omission of the marked function when the driver is not built as a module; again, in modules, it has no effect.</p>

<p>The use of <strong>init (and </strong>initdata for data items) can reduce the amount of memory used by the kernel. There is no harm in marking module initialization functions with __init, even though currently there is no benefit either. Management of initialization sections has not been implemented yet for modules, but it&rsquo;s a possible enhancement for the future.</p>

<p>Next comes the <code>MODULE_LICENCE</code> macro. Latest Kernels provide a mechanism to specify if the module is under GPL licence or not. A warning will be printed when you try to run it. To avoid this, you need to specify that the kernel module you have written is open source. To know more about GPL licence, you can visit <a href="http://www.gnu.org/copyleft/gpl.html">this</a>. You need to add the <code>MODULE_LICENCE</code> to prevent all such warnings.</p>

<p>Here&rsquo;s what included in the <code>[linux/module.h](http://lxr.free-electrons.com/source/include/linux/module.h)</code> about the GPL licence. Notice that the <code>MODULE_DISCRIPTION</code> and <code>MODULE_AUTHOR</code> have their usual meanings and are essential to be included in the LKM code.</p>

<pre><code>&lt;code&gt;
/*
 * The following license idents are currently accepted as indicating free
 * software modules
 *
 *  "GPL"               [GNU Public License v2 or later]
 *  "GPL v2"            [GNU Public License v2]
 *  "GPL and additional rights" [GNU Public License v2 rights and more]
 *  "Dual BSD/GPL"          [GNU Public License v2
 *                   or BSD license choice]
 *  "Dual MIT/GPL"          [GNU Public License v2
 *                   or MIT license choice]
 *  "Dual MPL/GPL"          [GNU Public License v2
 *                   or Mozilla license choice]
 *
 * The following other idents are available
 *
 *  "Proprietary"           [Non free products]
 *
 * There are dual licensed components, but when running with Linux it is the
 * GPL that is relevant so this is a non issue. Similarly LGPL linked with GPL
 * is a GPL combined work.
 *
 * This exists for several reasons
 * 1.   So modinfo can show license info for users wanting to vet their setup 
 *  is free
 * 2.   So the community can ignore bug reports including proprietary modules
 * 3.   So vendors can do likewise based on their own policies
 *  #define MODULE_LICENSE(_license) MODULE_INFO(license, _license)
 *
 * Author(s), use "Name " or just "Name", for multiple
 * authors use multiple MODULE_AUTHOR() statements/lines.
 *
 * #define MODULE_AUTHOR(_author) MODULE_INFO(author, _author)
 *
 * What your module does.
 * #define MODULE_DESCRIPTION(_description) MODULE_INFO(description, _description)
 */
&lt;/code&gt;
</code></pre>

<p>Now, we will add the required Macros as well as GPL license to our code.</p>

<p>Here&rsquo;s the final code.</p>

<pre><code>&lt;code&gt;
/*  
    Added macros and Documentation to first.c
    Author: Sricharan Chiruvolu
    Date: 14 Dec 2014
 */
#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/init.h&gt;
#define DRIVER_AUTHOR "Sricharan Chiruvolu "
#define DRIVER_DESC   "The First Program - Template"

static int __init first_init(void)
{
    printk(KERN_ALERT "This is our first program.");
    return 0;
}

static void __exit first_exit(void)
{
    printk(KERN_ALERT "End of our first program.");
}

module_init(first_init);
module_exit(first_exit);
MODULE_LICENSE("GPL");
MODULE_AUTHOR(DRIVER_AUTHOR);   
MODULE_DESCRIPTION(DRIVER_DESC);

/*  
 *  This module uses /dev/testdevice.  The MODULE_SUPPORTED_DEVICE macro might
 *  be used in the future to help automatic configuration of modules, but is 
 *  currently unused other than for documentation purposes.
 */
MODULE_SUPPORTED_DEVICE("testdevice");
&lt;/code&gt;
</code></pre>

<p>Now that we have written our first LKM at production level, we will be writing more advanced kernel modules in the following tutorials. We will be learning about /proc file system, Charaacter device files e.t.c.</p>

<p>Note the all the code is available at my <a href="https://github.com/raincrash/Writing-Kernel-Modules">github</a> page. Stay Tuned.</p>

          <br />
<p>
  sricharan
  <span class="muted">at 19:39</span>
</p>


        </section>
      </div>
      

      
        <div class="block">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = "bitspixelsandatoms"; 
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      
      <div class="block">
  
    <a target="_top" class="main" href="/about">About</a>
  
    <a target="_blank" class="main" href="http://github.com/sricharanized/">GitHub</a>
  
    <a target="_blank" class="main" href="http://twitter.com/TheRaincrash/">Twitter</a>
  
    <a target="_blank" class="main" href="http://linkedin.com/in/sricharanchiruvolu">LinkedIn</a>
  
    <a target="_blank" class="main" href="http://quora.com/Sricharan-Chiruvolu">Quora</a>
  
    <a target="_blank" class="main" href="mailto:sricharanized@gmail.com">E-Mail</a>
  
</div>
    </div>
    <footer>
  <br />
  <img src="/images/beaker.png" alt="Mr. Beaker" style="height: 20px; width: 20px;" /> 
  <br/>
  Developed with &hearts; for open-source. Hosted on github.
</footer>
  </body>
</html>
