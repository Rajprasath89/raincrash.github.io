<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Writing Kernel Modules::The Macros &middot; Bits, Pixels and Atoms
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/naringu.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/form.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="./public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="alternate" type="application/rss+xml" title="Mozilla RSS" href="feed.category.xml">
  </head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61456015-1', 'auto');
  ga('send', 'pageview');

</script>


<body class="theme-6dd">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
      <img width="125" height="125" alt="A photo of ariestiyansyah" src="/images/head.png">
    <p>Random tech musing by Sricharan Chiruvolu</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/categories/">Category Index</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/contact/">Contact</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="/assets/resume.pdf">Resume</a>
    <span class="sidebar-nav-item">Version 2.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Bits, Pixels and Atoms</a>
            <small>Random tech musing by Sricharan Chiruvolu</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Writing Kernel Modules::The Macros</h1>
  <span class="post-date">14 Dec 2014</span>
  <p>After writing our first <a href="http://sricharanized.wordpress.com/2014/12/14/writing-kernel-modules-lesson-five-our-first-kernel-module/">program</a>, we are now ready to modify it a litte. We will be using <code>module_init</code> and <code>module_exit</code> macros to rename our default <code>init_module()</code> and <code>cleanup_module()</code> respectively. Remember that you need to call these functions before calling the macros.</p>

<p>Also, We will be adding <code>__int</code> and <code>__exit</code> macros. These are macros to locate some parts of the linux code into special areas in the final executing binary. __init, for example instructs the compiler to mark this function in a special way. At the end the linker collects all functions with this mark at the end (or begin) of the binary file. If you what to know more you can read the <a href="http://lxr.free-electrons.com/source/include/linux/init.h">init.h</a> file along with the comments. This is the advantage of working with an open source operating system!</p>

<p>When the LKM starts, this code runs only once (initialization). After it runs, the kernel can free this memory to reuse it.</p>

<p>This is how our code was before we implimented it using modules.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/* 
    Our first kernel module - first.c 
    Author: Sricharan Chiruvolu
    Date: 14 Dec 2014
*/
#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;

int init_module(void){

    printk(KERN_INFO &quot;This is our first program.&quot;);

    return 0;
}

void cleanup_module(void){

    printk(KERN_INFO &quot;End of our first program.&quot;);
}
</code></pre></div>
<p>We will now modify it as follows.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/* 
    Edited first.c; Added macros module_init and module_exit
    Author: Sricharan Chiruvolu
    Date: 14 Dec 2014
*/
#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/init.h&gt;

static int __init firstInit(void)
{

    printk(KERN_ALERT &quot;This is our first program.&quot;);
    return 0;
}

static void __exit firstExit(void)
{
    printk(KERN_ALERT &quot;End of our first program.&quot;);
}

module_init(firstInit);
module_exit(firstExit);
</code></pre></div>
<p>Now you can <code>make</code> it. You will see that it behaves in the similar way as before. The difference? The attribute _<em>init, , will cause the initialization function to be discarded, and its memory reclaimed, after initialization is complete. It only works, however, for built-in drivers; it has no effect on modules. _</em>exit, instead, causes the omission of the marked function when the driver is not built as a module; again, in modules, it has no effect.</p>

<p>The use of _<em>init (and _</em>initdata for data items) can reduce the amount of memory used by the kernel. There is no harm in marking module initialization functions with __init, even though currently there is no benefit either. Management of initialization sections has not been implemented yet for modules, but it&#39;s a possible enhancement for the future.</p>

<p>Next comes the <code>MODULE_LICENCE</code> macro. Latest Kernels provide a mechanism to specify if the module is under GPL licence or not. A warning will be printed when you try to run it. To avoid this, you need to specify that the kernel module you have written is open source. To know more about GPL licence, you can visit <a href="http://www.gnu.org/copyleft/gpl.html">this</a>. You need to add the <code>MODULE_LICENCE</code> to prevent all such warnings. </p>

<p>Here&#39;s what included in the <code>[linux/module.h](http://lxr.free-electrons.com/source/include/linux/module.h)</code> about the GPL licence. Notice that the <code>MODULE_DISCRIPTION</code> and <code>MODULE_AUTHOR</code> have their usual meanings and are essential to be included in the LKM code.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;code&gt;
/*
 * The following license idents are currently accepted as indicating free
 * software modules
 *
 *  &quot;GPL&quot;               [GNU Public License v2 or later]
 *  &quot;GPL v2&quot;            [GNU Public License v2]
 *  &quot;GPL and additional rights&quot; [GNU Public License v2 rights and more]
 *  &quot;Dual BSD/GPL&quot;          [GNU Public License v2
 *                   or BSD license choice]
 *  &quot;Dual MIT/GPL&quot;          [GNU Public License v2
 *                   or MIT license choice]
 *  &quot;Dual MPL/GPL&quot;          [GNU Public License v2
 *                   or Mozilla license choice]
 *
 * The following other idents are available
 *
 *  &quot;Proprietary&quot;           [Non free products]
 *
 * There are dual licensed components, but when running with Linux it is the
 * GPL that is relevant so this is a non issue. Similarly LGPL linked with GPL
 * is a GPL combined work.
 *
 * This exists for several reasons
 * 1.   So modinfo can show license info for users wanting to vet their setup 
 *  is free
 * 2.   So the community can ignore bug reports including proprietary modules
 * 3.   So vendors can do likewise based on their own policies
 *  #define MODULE_LICENSE(_license) MODULE_INFO(license, _license)
 *
 * Author(s), use &quot;Name &quot; or just &quot;Name&quot;, for multiple
 * authors use multiple MODULE_AUTHOR() statements/lines.
 *
 * #define MODULE_AUTHOR(_author) MODULE_INFO(author, _author)
 *
 * What your module does.
 * #define MODULE_DESCRIPTION(_description) MODULE_INFO(description, _description)
 */
&lt;/code&gt;
</code></pre></div>
<p>Now, we will add the required Macros as well as GPL license to our code.</p>

<p>Here&#39;s the final code.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;code&gt;
/*  
    Added macros and Documentation to first.c
    Author: Sricharan Chiruvolu
    Date: 14 Dec 2014
 */
#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/init.h&gt;
#define DRIVER_AUTHOR &quot;Sricharan Chiruvolu &quot;
#define DRIVER_DESC   &quot;The First Program - Template&quot;

static int __init first_init(void)
{
    printk(KERN_ALERT &quot;This is our first program.&quot;);
    return 0;
}

static void __exit first_exit(void)
{
    printk(KERN_ALERT &quot;End of our first program.&quot;);
}

module_init(first_init);
module_exit(first_exit);
MODULE_LICENSE(&quot;GPL&quot;);
MODULE_AUTHOR(DRIVER_AUTHOR);   
MODULE_DESCRIPTION(DRIVER_DESC);

/*  
 *  This module uses /dev/testdevice.  The MODULE_SUPPORTED_DEVICE macro might
 *  be used in the future to help automatic configuration of modules, but is 
 *  currently unused other than for documentation purposes.
 */
MODULE_SUPPORTED_DEVICE(&quot;testdevice&quot;);
&lt;/code&gt;
</code></pre></div>
<p>Now that we have written our first LKM at production level, we will be writing more advanced kernel modules in the following tutorials. We will be learning about /proc file system, Charaacter device files e.t.c.</p>

<p>Note the all the code is available at my <a href="https://github.com/raincrash/Writing-Kernel-Modules">github</a> page. Stay Tuned.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/bioinformatics/2015/08/15/Modelling-a-simple-ga/">
            Modelling a simple genetic algorithm
            <small>15 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bioinformatics/2015/08/10/genetic-algorithms-hello-world/">
            A "Hello World!" to the genetic algorithms
            <small>10 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/gsoc/2015/06/05/pysoy-pysoy-development-part-two/">
            [Pysoy] - Pysoy Development, Part Two
            <small>05 Jun 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'bitspixelsandatoms';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'bitspixelsandatoms';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

    <div align="center" class="footer">
    <br />
    <a href="https://twitter.com/TheRaincrash" class="twitter-follow-button" data-show-count="false" data-size="large" data-dnt="true">Follow @TheRaincrash</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <br/>
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Bits, Pixels and Atoms</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="mailto:sricharanized@gmail.com" property="cc:attributionName" rel="cc:attributionURL">Sricharan Chiruvolu</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons License.</a><br/>
    </div>
  </body>
</html>

