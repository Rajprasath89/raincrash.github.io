<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Writing Kernel Modules:: Our first kernel module &middot; Bits, Pixels and Atoms
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/naringu.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/form.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="./public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="alternate" type="application/rss+xml" title="Mozilla RSS" href="feed.category.xml">
  </head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61456015-1', 'auto');
  ga('send', 'pageview');

</script>


<body class="theme-6dd">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
      <img width="125" height="125" alt="A photo of ariestiyansyah" src="/images/head.png">
    <p>Random tech musing by Sricharan Chiruvolu</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/categories/">Category Index</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/contact/">Contact</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="/assets/resume.pdf">Resume</a>
    <span class="sidebar-nav-item">Version 2.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Bits, Pixels and Atoms</a>
            <small>Random tech musing by Sricharan Chiruvolu</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Writing Kernel Modules:: Our first kernel module</h1>
  <span class="post-date">14 Dec 2014</span>
  <p>Finally, It&#39;s time to write our first kernel module. But before that, do you know what <code>printk()</code> is? It&#39;s not an output statement. It is used to log information or give warnings for the kernel. The kernel uses the loglevel to decide whether to print the message to the console. The kernel displays all messages with a loglevel below a specified value on the console.</p>

<p>You specify a loglevel like this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    printk(KERN_WARNING &quot;This is a warning!\n&quot;);
    printk(KERN_DEBUG &quot;This is a debug notice!\n&quot;);
    printk(&quot;I did not specify a loglevel!\n&quot;)
</code></pre></div>
<p>The <code>KERN_WARNING</code> and <code>KERN_DEBUG</code> strings are simple defines found in <linux/ kernel.h>. They expand to a string such as &quot;<4>&quot; or &quot;<7>&quot; that is concatenated onto the front of the printk() message. The kernel then decides which messages to print on the console based on this specified loglevel and the current console loglevel, <code>console_loglevel</code>. If you do not specify a loglevel, it defaults to <code>DEFAULT_MESSAGE_LOGLEVEL</code>, which is currently <code>KERN_WARNING</code>. Because this value might change, you should always specify a loglevel for your messages.</p>

<p>Here&#39;s a what each <code>loglevel</code> mean:</p>

<ul>
<li><p> KERN_EMERG - An emergency condition; the system is probably dead</p></li>
<li><p>KERN_ALERT - A problem that requires immediate attention</p></li>
<li><p>KERN_CRIT - A critical condition</p></li>
<li><p>KERN_ERR - An error</p></li>
<li><p>KERN_WARINING - A warning</p></li>
<li><p>KERN_NOTICE - A normal, but perhaps noteworthy, condition</p></li>
<li><p>KERN_INFO - An informational message</p></li>
<li><p>KERN_DEBUG - A debug message typically superfluous</p></li>
</ul>

<p>Okay. Enough of prerequisites. Here is our first kernel module code. Don&#39; t compile it yet. We will improvise the code. This is just the basic template.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/* 
    Our first kernel module - first.c 
    Author: Sricharan Chiruvolu
    Date: 14 Dec 2014
*/
#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;

int init_module(void){

    //Our initial code goes here...

    return 0;
}

void cleanup_module(void){

    //The terminating code goes here...
}
</code></pre></div>
<p>The <code>init_module</code> function is called after the module is loaded into the kernel and the <code>cleanup_module</code> function is called just before removing the module from the kernel.</p>

<p>Note that the use of <code>cleanup_module</code> function is to explicitly undo the changes of <code>init_module</code> and remove the module safely from the kernel.</p>

<p>Also, all the source code can be downloaded <a href="https://github.com/raincrash/Writing-Kernel-Modules">here</a>. Each program is committed according to this tutorial. So you can visit the previous commits for the appropriate one.</p>

<hr>

<p>Now, let&#39;s add some output statements to our program. As already mentioned, we will use <code>printk()</code>.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/* 
    Our first kernel module - first.c 
    Author: Sricharan Chiruvolu
    Date: 14 Dec 2014
*/
#include 
#include 

int init_module(void){

    printk(KERN_ALERT &quot;This is our first program.&quot;);

    return 0;
}

void cleanup_module(void){

    printk(KERN_ALERT &quot;End of our first program.&quot;);
}
</code></pre></div>
<p>Now we are ready to test our module. After writing the proper Makefile, run the <code>**make**</code> command. If you have any issues refer to the previous <a href="http://sricharanized.wordpress.com/2014/12/14/writing-kernel-modules-lesson-four-compiling-kernel-modules/">tutorial</a>.</p>

<p>You should get something like this in your terminal</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">make -C /lib/modules/3.13.0-43-generic/build M=/home/sricharan/kernel modules
make[1]: Entering directory `/usr/src/linux-headers-3.13.0-43-generic&#39;
  CC [M]  /home/sricharan/kernel/first.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/sricharan/kernel/first.mod.o
  LD [M]  /home/sricharan/kernel/first.ko
make[1]: Leaving directory `/usr/src/linux-headers-3.13.0-43-generic&#39;
</code></pre></div>
<p>Your first kernel module is ready. Load it to the kernel with the following command <code>insmod first.ko</code>. Note that you need sufficient privileges to do so.</p>

<p>Our LKM is loaded into the kernel. As already discussed in the previous <a href="http://sricharanized.wordpress.com/2014/12/14/writing-kernel-modules-lesson-four-compiling-kernel-modules/">tutorial</a>, you can check out <code>/proc/modules</code> for our kernel module.</p>

<p>As of now, let&#39;s remove it from the kernel. Run the <code>rmmod first</code> command to do so.
In the following tutorials we will dive deep into more advanced LKM code.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/bioinformatics/2015/08/15/Modelling-a-simple-ga/">
            Modelling a simple genetic algorithm
            <small>15 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bioinformatics/2015/08/10/genetic-algorithms-hello-world/">
            A "Hello World!" to the genetic algorithms
            <small>10 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/gsoc/2015/06/05/pysoy-pysoy-development-part-two/">
            [Pysoy] - Pysoy Development, Part Two
            <small>05 Jun 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'bitspixelsandatoms';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'bitspixelsandatoms';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

    <div align="center" class="footer">
    <br />
    <a href="https://twitter.com/TheRaincrash" class="twitter-follow-button" data-show-count="false" data-size="large" data-dnt="true">Follow @TheRaincrash</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <br/>
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Bits, Pixels and Atoms</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="mailto:sricharanized@gmail.com" property="cc:attributionName" rel="cc:attributionURL">Sricharan Chiruvolu</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons License.</a><br/>
    </div>
  </body>
</html>

