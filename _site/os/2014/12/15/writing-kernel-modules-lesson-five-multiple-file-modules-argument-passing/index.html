<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Writing Kernel Modules::Multiple file modules &middot; Bits, Pixels and Atoms
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/naringu.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/form.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="./public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="alternate" type="application/rss+xml" title="Mozilla RSS" href="feed.category.xml">
  </head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61456015-1', 'auto');
  ga('send', 'pageview');

</script>


<body class="theme-6dd">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
      <img width="125" height="125" alt="A photo of ariestiyansyah" src="/images/head.png">
    <p>Random tech musing by Sricharan Chiruvolu</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/categories/">Category Index</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/contact/">Contact</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="/assets/resume.pdf">Resume</a>
    <span class="sidebar-nav-item">Version 2.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Bits, Pixels and Atoms</a>
            <small>Random tech musing by Sricharan Chiruvolu</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Writing Kernel Modules::Multiple file modules</h1>
  <span class="post-date">15 Dec 2014</span>
  <p>Before we get into the real stuff, there are a few must-knows that are worth discussing. Note the our purpose of this tutorial set is to write our own LKMs and Rootkits for our own purposes. Few of them might have to be written in multiple files or require some arguments to be passed. We will discuss these issues now.
**
Command-line Arguments**</p>

<p>Command-line arguments are declared by defining the variables that take these arguments as global and using the <code>module_param()</code> macro. The variable declaration is usually described at the beginning of the module. The <code>insmod</code> is used to pass the values at runtime. Arrays of Integers or Strings are called using <code>module_param_array</code> and <code>module_param_string</code> macros.</p>

<p>The <code>module_param_desc</code> is used to document arguments that the module can take.</p>

<p>This is how command-line variables are declared.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;code&gt;
int number = 100;
module_param(number, int , 0); // module_param(variable_name, variable_type , permissions);

// This is how arrays are declared

int numberArray[5];
module_param_array(numberArray, int, NULL, 0); /* not interested in count */

int numberArray2[30];
int count;
module_param_array(numberArray2, short, count, 0); /* put count into &quot;count&quot; variable */

&lt;/code&gt;
</code></pre></div>
<p>Here&#39;s a sample program using command-line arguments.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;code&gt;
/*  
    Using Command-line arguments
    Author: Sricharan Chiruvolu
    Date: 14 Dec 2014
 */
#include &lt;linux/module.h&gt;    
#include &lt;linux/kernel.h&gt;
#include &lt;linux/init.h&gt;
#include &lt;linux/moduleparam.h&gt;
#include &lt;linux/stat.h&gt;


#define DRIVER_AUTHOR &quot;Sricharan Chiruvolu &quot;
#define DRIVER_DESC   &quot;The First Program - Template&quot;

//Declaring a few variables...
static short int short_number = 1;
module_param(short_number, short, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
MODULE_PARM_DESC(short_number, &quot;A short Number&quot;);


static int number = 54;
module_param(number, int, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
MODULE_PARM_DESC(number, &quot;A Number&quot;);


static long int long_number = 33553466;
module_param(long_number, short, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
MODULE_PARM_DESC(long_number, &quot;A long Number&quot;);


static char *char_string = &quot;Hello&quot;;
module_param(char_string, charp, 0000);
MODULE_PARM_DESC(char_string, &quot;A character string&quot;);

static int __init first_init(void)
{
    int integerA;
    printk(KERN_INFO &quot;This is our first program.&quot;);
    printk(KERN_INFO &quot;short_number is a short integer: %hd\n&quot;, short_number);
    printk(KERN_INFO &quot;number is an integer: %d\n&quot;, number);
    printk(KERN_INFO &quot;long_number is a long integer: %ld\n&quot;, long_number);
    printk(KERN_INFO &quot;char_string is a string: %s\n&quot;, char_string);

    return 0;
}

static void __exit first_exit(void)
{
    printk(KERN_ALERT &quot;End of our first program.&quot;);
}

module_init(first_init);
module_exit(first_exit);
MODULE_LICENSE(&quot;GPL&quot;);
MODULE_AUTHOR(DRIVER_AUTHOR);   
MODULE_DESCRIPTION(DRIVER_DESC);

/*  
 *  This module uses /dev/testdevice.  The MODULE_SUPPORTED_DEVICE macro might
 *  be used in the future to help automatic configuration of modules, but is 
 *  currently unused other than for documentation purposes.
 */
MODULE_SUPPORTED_DEVICE(&quot;testdevice&quot;);

&lt;/code&gt;
</code></pre></div>
<p>Now that we know how to send command-line arguments let&#39;s. We will next see how multiple file modules work.</p>

<hr>

<p>Quite often, it is logically suitable to write multi-file kernel modules. Let&#39;s write one now. We will use two files <code>third_one.c</code> and <code>third_one.c</code> for this.</p>

<p><code>third_one.c</code> will look like this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;code&gt;
/*  
    Using multiple files - Part one
    Author: Sricharan Chiruvolu
    Date: 16 Dec 2014
 */
#include &lt;linux/kernel.h&gt;
#include &lt;linux/module.h&gt;
int init_module(void)
{
    printk(KERN_INFO &quot;Hello, world - this is the kernel speaking\n&quot;);
    return 0;
}
&lt;/code&gt;
</code></pre></div>
<p>and the other one, <code>third_two.c</code> will be:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;code&gt;
/*  
    Using multiple files - Part two
    Author: Sricharan Chiruvolu
    Date: 16 Dec 2014
 */

#include &lt;linux/kernel.h&gt;
#include &lt;linux/module.h&gt;

void cleanup_module()
{
    printk(KERN_INFO &quot;Short is the life of a kernel module\n&quot;);
}
&lt;/code&gt;
</code></pre></div>
<p>You can see that it&#39;s just the same program as our <a href="http://sricharanized.wordpress.com/2014/12/14/writing-kernel-modules-lesson-five-our-first-kernel-module/">first</a> but is in two different files.</p>

<p>We are only supposed to change our Makefile to build both the object files of our program one after the other and create a combined object code. The modified <code>Makefile</code> looks like this.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;code&gt;
obj-m += combined_module.o
combined_module-objs := third_one.o third_two.o

all:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules

clean:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
&lt;/code&gt;
</code></pre></div>
<p>You can now run <code>make</code> command to find the <code>combined_module.ko</code> kernel module.</p>

<p>We have successfully written a basic multi-file kernel module. In the next tutorial, we will discuss about character device drivers. So, stay tuned.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/08/10/genetic-algorithms-hello-world/">
            A "Hello World!" to the genetic algorithms
            <small>10 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/gsoc/2015/06/05/pysoy-pysoy-development-part-two/">
            [Pysoy] - Pysoy Development, Part Two
            <small>05 Jun 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/web%20dev/2015/06/05/the-new-web-development-treads/">
            The new web development trends
            <small>05 Jun 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'bitspixelsandatoms';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'bitspixelsandatoms';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

    <div align="center" class="footer">
    <br />
    <a href="https://twitter.com/TheRaincrash" class="twitter-follow-button" data-show-count="false" data-size="large" data-dnt="true">Follow @TheRaincrash</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <br/>
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Bits, Pixels and Atoms</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="mailto:sricharanized@gmail.com" property="cc:attributionName" rel="cc:attributionURL">Sricharan Chiruvolu</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons License.</a><br/>
    </div>
  </body>
</html>

